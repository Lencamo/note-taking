## ä¸‰ã€HTTP è¯·æ±‚

&emsp;&emsp;ä¸Šé¢çš„ http æ¨¡å—æ˜¯ä½œä¸º node æœåŠ¡ç«¯çš„å½¢å¼å­˜åœ¨çš„ã€‚å…¶å®ï¼Œhttp æ¨¡å—ä¹Ÿå¯ä»¥ä½œä¸º node å®¢æˆ·ç«¯çš„å½¢å¼å­˜åœ¨ã€‚

> æ‰€ä»¥åœ¨æœåŠ¡ç«¯ä¸­ï¼Œnode å…¶å®æ›´å¤šçš„æ˜¯æ‰®æ¼” <span style="background-color:yellow;color:black">ä¸­é—´ä»¶</span>ï¼ˆä¸­é—´å±‚ï¼‰ çš„è§’è‰²ã€‚

### node ä¸ä¸­é—´ä»¶

&emsp;&emsp;ç”±äºæ‰€ä»¥ JSONP è§£å†³è·¨åŸŸé—®é¢˜æ—¶ï¼ŒåŸç”Ÿ js æ–¹å¼ç¹çï¼Œè€Œä½¿ç”¨ jQuery çš„ ajax æ—¶åˆæœ‰æ¡ä»¶é™åˆ¶ã€‚æ‰€ä»¥é€šå¸¸<span style="color:red;">æœ€ä½³æ–¹æ¡ˆ</span>ä¸ºï¼šåœ¨åç«¯è§£å†³è·¨åŸŸé—®é¢˜ã€‚

å›¾è§£ï¼š

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220612214816.png" width=593.5px />

&emsp;&emsp;è¦æƒ³å®ç°ä¸Šè¿°çš„æ„æƒ³ï¼Œè¦ä½¿ç”¨ node çš„ https çš„ API æ–¹æ³•ã€‚

- https.get()
- https.request()

### 1ã€get è¯·æ±‚

- `https.get(url[, options][, callback])`

> çŒ«çœ¼ï¼šhttps://i.maoyan.com/api/mmdb/movie/v3/list/hot.json?ct=%E5%8C%97%E4%BA%AC&ci=1&channelId=4

â‘  å‰ç«¯

```html
<body>
  <script>
    fetch('http://127.0.0.1:3000/api/list')
      .then((res) => res.json())
      .then((res) => {
        console.log(res)
      })
  </script>
</body>
```

â‘¡ åç«¯

```js
const http = require('http')
const url = require('url')
const https = require('https')

// åˆ›å»ºwebæœåŠ¡å™¨
http
  .createServer((req, res) => {
    const urlobj = url.parse(req.url, true)
    callbackName = urlobj.query.callback

    res.writeHead(200, {
      'content-type': 'application',
      // è·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆï¼šCORSå¤´
      'Access-Control-Allow-Origin': '*'
    })

    switch (urlobj.pathname) {
      case '/api/list':
        // ä½¿ç”¨ğŸš©å›è°ƒå‡½æ•°ï¼ˆè§£å†³å¼‚æ­¥é—®é¢˜ï¼‰
        // ä½œä¸ºå®¢æˆ·ç«¯ï¼Œå»çŒ«çœ¼è¦æ•°æ®
        http_get((data) => {
          res.end(data)
        })

        break
      default:
        res.end('404')
        break
    }
    res.end()
  })
  .listen(3000, '127.0.0.1', () => {
    console.log('Server running at http://127.0.0.1:3000')
  })

function http_get(cb) {
  var data = ''
  // ä½¿ç”¨nodeâœ¨å‘èµ·getè¯·æ±‚ï¼ˆå¸®åŠ©å‰ç«¯è·¨åŸŸè·å–â€œçŒ«çœ¼â€æ•°æ®ï¼‰
  https.get(
    `https://i.maoyan.com/api/mmdb/movie/v3/list/hot.json?ct=%E5%8C%97%E4%BA%AC&ci=1&channelId=4`,
    (res) => {
      res.on('data', (chunk) => {
        data += chunk
      })

      res.on('end', () => {
        // response.end(data)
        cb(data)
      })
    }
  )
}
```

### 2ã€post è¯·æ±‚

- `https.request(options[, callback])`

> å°ç±³æœ‰å“ï¼šhttps://xiaomiyoupin.com/mtop/market/search/placeHolder

â‘  å‰ç«¯

```html
<body>
  <script>
    fetch('http://127.0.0.1:3000/api/list')
      .then((res) => res.json())
      .then((res) => {
        console.log(res)
      })
  </script>
</body>
```

â‘¡ åç«¯

```js
const http = require('http')
const url = require('url')
const https = require('https')

// åˆ›å»ºwebæœåŠ¡å™¨
http
  .createServer((req, res) => {
    const urlobj = url.parse(req.url, true)
    callbackName = urlobj.query.callback

    res.writeHead(200, {
      'content-type': 'application',
      // è·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆï¼šCORSå¤´
      'Access-Control-Allow-Origin': '*'
    })

    switch (urlobj.pathname) {
      case '/api/list':
        // ä½¿ç”¨ğŸš©å›è°ƒå‡½æ•°ï¼ˆç›´æ¥ä¼ å‚ä¼šå¯¼è‡´è€¦åˆæ€§ï¼‰
        // ä½œä¸ºå®¢æˆ·ç«¯ï¼Œå»å°ç±³æœ‰å“è¦æ•°æ®
        http_post((data) => {
          res.end(data)
        })

        break
      default:
        res.end('404')
        break
    }
    res.end()
  })
  .listen(3000, '127.0.0.1', () => {
    console.log('Server running at http://127.0.0.1:3000')
  })

function http_post(cb) {
  var data = ''

  var options = {
    hostname: 'm.xiaomiyoupin.com',
    port: '443',
    path: 'mtop/market/search/placeHolder',
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  }

  // ä½¿ç”¨nodeâœ¨å‘èµ·postè¯·æ±‚ï¼ˆå¸®åŠ©å‰ç«¯è·¨åŸŸè·å–â€œçŒ«çœ¼â€â€æ•°æ®ï¼‰
  var req = https.request(options, (res) => {
    res.on('data', (chunk) => {
      data += chunk
    })

    res.on('end', () => {
      cb(data)
    })
  })

  req.write([{}, { baseParam: { ypClient: 1 } }])
  req.end()
}
```

### 3ã€æ‹“å±•ï¼šcheerio åŒ…

çˆ¬è™«æ¨¡å‹ï¼š

&emsp;&emsp;æœ‰æ—¶å‰ç«¯å¯èƒ½ä¸ä¼šè¦æ‰€æœ‰çš„æ•°æ®ï¼Œæˆ‘ä»¬åç«¯å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥æ‹¿å–ç½‘é¡µçˆ¬å–æ•°æ®ï¼Œç„¶åæŒ‰éœ€ä¸ºå‰ç«¯æä¾›æ•°æ®ã€‚

```sh
npm i cheerio -S
```

å®˜æ–¹ï¼š

> [cheerio](https://cheerio.js.org/)æ˜¯ä¸€æ¬¾éå¸¸å®ç”¨çš„ nodejs ç¬¬ä¸‰æ–¹åŒ…ï¼Œé€‚ç”¨äºæœåŠ¡ç«¯ï¼ˆnodejs ç«¯ï¼‰å¤„ç† htmlã€‚å®ƒæœ‰ç€ä¸ jquery åŠå…¶ç›¸ä¼¼ï¼ˆå‡ ä¹æ˜¯ä¸€è‡´ï¼‰çš„ apiï¼Œé€Ÿåº¦é£å¿«ï¼Œä½¿ç”¨çµæ´»ï¼Œè€Œä¸”ä¸ä»…èƒ½å¤Ÿå¤„ç† htmlï¼ŒåŒæ ·ä¹Ÿèƒ½å¤„ç† xmlã€‚

éœ€æ±‚ï¼š

&emsp;&emsp;è·å–ç”µå½±åˆ—è¡¨çš„ç”µå½±åã€è¯„åˆ†ã€ä¸»æ¼”ç»„æˆçš„ json æ•°æ®ã€‚

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220613104655.png" width=579px />

â‘  å‰ç«¯

```html
<body>
  <script>
    fetch('http://127.0.0.1:3000/api/list')
      .then((res) => res.json())
      .then((res) => {
        console.log(res)
      })
  </script>
</body>
```

â‘¡ åç«¯

```js
const http = require('http')
const url = require('url')
const https = require('https')
const cheerio = require('cheerio')

// åˆ›å»ºwebæœåŠ¡å™¨
http
  .createServer((req, res) => {
    const urlobj = url.parse(req.url, true)
    callbackName = urlobj.query.callback

    res.writeHead(200, {
      'content-type': 'application',
      // è·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆï¼šCORSå¤´
      'Access-Control-Allow-Origin': '*'
    })

    switch (urlobj.pathname) {
      case '/api/list':
        http_get((data) => {
          // å¯¹ç½‘é¡µæ•°æ®è¿›è¡Œè¿‡æ»¤
          res.end(spider(data))
        })

        break
      default:
        res.end('404')
        break
    }
    res.end()
  })
  .listen(3000, '127.0.0.1', () => {
    console.log('Server running at http://127.0.0.1:3000')
  })

function http_get(cb) {
  var data = ''
  // ä½¿ç”¨nodeâœ¨å‘èµ·getè¯·æ±‚ï¼ˆå¸®åŠ©å‰ç«¯è·¨åŸŸè·å–â€œçŒ«çœ¼â€æ•°æ®ï¼‰
  https.get(`https://i.maoyan.com/`, (res) => {
    res.on('data', (chunk) => {
      data += chunk
    })

    res.on('end', () => {
      // response.end(data)
      cb(data)
    })
  })
}

function spider(data) {
  let $ = cheerio.load(data)

  let $moviewlist = $('.column.content')
  let movies = []

  $moviewlist.each((index, value) => {
    movies.push({
      title: $(value).find('.title').text(),
      grade: $(value).find('.grade').text(),
      actor: $(value).find('.actor').text()
    })
  })

  return JSON.stringify(movies)
}
```

## å››ã€Node.js å†…ç½®æ¨¡å—ï¼ˆä¸‹ï¼‰

### 1ã€event äº‹ä»¶è§¦å‘å™¨

- ä¸å¸¦å‚

```js
const EventEmitter = require('events')

const event = new EventEmitter()

// ä½¿ç”¨event.onâœ¨ç›‘å¬playäº‹ä»¶
event.on('play', () => {
  console.log('äº‹ä»¶è¢«è§¦å‘äº†')
})

// ä½¿ç”¨event.emitâœ¨è§¦å‘playäº‹ä»¶
setTimeout(() => {
  event.emit('play')
}, 2000)
```

- å¸¦å‚

```js
const EventEmitter = require('events')

const event = new EventEmitter()

event.on('play', (data) => {
  console.log('äº‹ä»¶è¢«è§¦å‘äº†-play', data)
})
event.on('run', (data) => {
  console.log('äº‹ä»¶è¢«è§¦å‘äº†-play', data)
})

// ä½¿ç”¨event.emitè§¦å‘äº‹ä»¶
setTimeout(() => {
  event.emit('play', '123')
}, 2000)

event.emit('run', '123')
event.emit('run', '456')
```

- åº”ç”¨åœºæ™¯

&emsp;&emsp;ä»¥å‰é¢çš„æ¡ˆä¾‹çš„ get è¯·æ±‚ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä¸ºäº†è§£å†³æ‹¿å–çŒ«çœ¼æ•°æ®æ—¶å­˜åœ¨å¼‚æ­¥çš„é—®é¢˜ï¼Œé‡‡ç”¨äº†å›è°ƒçš„æ–¹å¼è§£å†³äº†é—®é¢˜ã€‚

> ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ Node è§¦å‘å™¨æ¥å®ç°ä¸€ä¸‹ã€‚

```js
const http = require('http')
const url = require('url')
const https = require('https')
const EventEmitter = require('events')

// åˆ›å»ºwebæœåŠ¡å™¨
http
  .createServer((req, res) => {
    const urlobj = url.parse(req.url, true)
    callbackName = urlobj.query.callback

    res.writeHead(200, {
      'content-type': 'application',
      // è·¨åŸŸé—®é¢˜è§£å†³æ–¹æ¡ˆï¼šCORSå¤´
      'Access-Control-Allow-Origin': '*'
    })

    // æ¡ˆä¾‹å‡çº§ï¼š
    var event = null
    switch (urlobj.pathname) {
      case '/api/list':
        // åˆ›å»ºeventå¯¹è±¡
        event = new EventEmitter()

        // 1ã€ç›‘å¬palyäº‹ä»¶
        event.on('play', (data) => {
          res.end(data)
        })
        // å‘èµ·æ•°æ®è¯·æ±‚
        http_get()

        // http_get((data) => {
        //   res.end(data)
        // })

        break
      default:
        res.end('404')
        break
    }
    res.end()
  })
  .listen(3000, '127.0.0.1', () => {
    console.log('Server running at http://127.0.0.1:3000')
  })

function http_get() {
  var data = ''
  https.get(
    `https://i.maoyan.com/api/mmdb/movie/v3/list/hot.json?ct=%E5%8C%97%E4%BA%AC&ci=1&channelId=4`,
    (res) => {
      res.on('data', (chunk) => {
        data += chunk
      })

      // 2ã€æ•°æ®è·å–å®Œåï¼Œè§¦å‘playäº‹ä»¶
      res.on('end', () => {
        // cb(data)
        event.emit('play', data)
      })
    }
  )
}
```

### 2ã€stream æµæ¨¡å—

- è¯»å…¥æµ

```js
var fs = require('fs')

//æ‰“å¼€è¯»å…¥æµ
var rs = fs.createReadStream('./sample.txt', 'utf-8')

// è¯»å–å¹¶æ‰“å°æ•°æ®
rs.on('data', function (chunk) {
  console.log('DATA:' + chunk)
})

rs.on('end', function () {
  console.log('END')
})

rs.on('error', function (err) {
  console.log('ERROR:' + err)
})
```

- å†™å…¥æµ

```js
var fs = require('fs')

//æ‰“å¼€å†™å…¥æµ
var ws = fs.createWriteStream('./sample.txt', 'utf-8')

// å†™å…¥æ•°æ®
ws.write('é˜¿è¨å¾·æ³•å¸ˆæ³•å¤§æ³•å¸ˆçš„æ³•å¸ˆçš„å‘å•Š')

ws.end()
```

- åº”ç”¨ï¼šå¤åˆ¶ã€ç²˜è´´

```js
const fs = require('fs')

const rs = fs.createReadStream('./1.txt')
const ws = fs.createWriteStream('./2.txt')

rs.pipe(ws)
```

### 3ã€zlib å‹ç¼©

å›¾ç¤ºï¼š

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220613173431.png" width=296px />

- æ•°æ®ä¼ è¾“

```js
const http = require('http')
const fs = require('fs')

const zlib = require('zlib')
const gzip = zlib.createGzip()

http
  .createServer((req, res) => {
    // å¯è¯»æµ
    const rs = fs.createReadStream('./1.txt')

    // ä¸ºæµè§ˆå™¨é…ç½®è®©å…¶å¯¹æ‰“åŒ…çš„æ–‡ä»¶è§£å‹
    res.writeHead(200,{'Content-Type':'application/x-javascript;charset=utf-8';'Content-Encoding':'gzip'})

    // å¯¹æ–‡ä»¶è¿›è¡Œå‹ç¼© pipe(gzip)
    // resï¼šæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªğŸŒˆå¯å†™æµï¼ˆwsï¼‰
    rs.pipe(gzip).pipe(res)
    res.end()
  })
  .listen(8080, '127.0.0.1', () => {
    console.log('Server running at http://127.0.0.1:8080')
  })
```

### 4ã€crypto æ¨¡å—

&emsp;&emsp;crypto æ¨¡å—çš„ç›®çš„æ˜¯ä¸ºäº†æä¾›é€šç”¨çš„åŠ å¯†å’Œå“ˆå¸Œç®—æ³•ã€‚åŠ å¯†åçš„ç»“æœæ ¼å¼é€šå¸¸æœ‰ï¼šhex(åå…­è¿›åˆ¶æ•°)ã€base64ã€binary(äºŒè¿›åˆ¶æ•°)ç­‰ç­‰

&emsp;&emsp;å¸¸è§çš„åº”ç”¨åœºæ™¯æœ‰ï¼šæ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒã€æ•°æ®åŠ å¯†ç­‰ç­‰

- å“ˆå¸Œç®—æ³•ï¼ˆHashï¼‰

> å¸¸è§çš„å“ˆå¸Œç®—æ³•æœ‰ï¼šMD5ã€sha1

```js
const crypto = requrie('crypto')

// 1ã€ä½¿ç”¨çš„ç®—æ³•
const hash = crypto.createHash('md5')
// const hash = crypto.createHash('sha1')

// å¯è°ƒç”¨ä»»æ„æ¬¡update()
hash.update('My blog is deer-sir.cn')

// 2ã€è¾“å‡ºçš„å†…å®¹æ ¼å¼
console.log(hash.digest('hex'))
// console.log(hash.digest('base64'))
```

- éšæœºæ•°å¢å¼ºçš„å“ˆå¸Œç®—æ³•ï¼ˆHmacï¼‰

> å¸¸è§çš„å“ˆå¸ŒåŠ å¯†ç®—æ³•æœ‰ï¼šMD5ã€shaã€sha256

```js
const crypto = requrie('crypto')

// æ³¨æ„ï¼šåŠ äº†ä¸€ä¸ªğŸš©ç§˜é’¥
const hmac = crypto.createHmac('sha256', 'secret-key')

hmac.update('My blog is deer-sir.cn')

console.log(hmac.digest('hex'))
```

- å¯¹ç§°<span style="color:red;">åŠ å¯†</span>ç®—æ³•ï¼ˆAESï¼‰

> å¸¸è§çš„å¯¹ç§°åŠ å¯†ç®—æ³•ï¼šaes-128-cbc

```js
// 1ã€å°è£…åŠ å¯† å’Œ è§£å¯†å‡½æ•°
function encrypt(key, iv, data) {
  let dep = crypto.createCipheriv('aes-128-cbc', key, iv)

  // è®¾ç½®è¾“å…¥ã€è¾“å‡ºæ ¼å¼
  return dep.update(data, 'binary', 'hex') + dep.final('hex')
}

function decrypt(key, iv, cryted) {
  crypted = Buffer.from(crypted, 'hex').toString('binary')

  let dep = crypto.createDecipheriv('aes-128-cbc', key, iv)

  // è¿”å›utf8æ ¼å¼çš„æ•°æ®
  return dep.update(crypted, 'binary', 'utf8') + dep.final('utf8')
}

// 2ã€ä½¿ç”¨ç¤ºä¾‹
// 16*8=128
let key = 'abcdef1234567890'
let iv = '12abc34567890def'

let data = 'lencamo'

let cryted = encrypt(key, iv, data)
console.log('åŠ å¯†ç»“æœä¸ºï¼š', cryted)

let decrypted = decrypt(key, iv, cryted)
console.log('è§£å¯†ç»“æœä¸ºï¼š', decrypted)
```
