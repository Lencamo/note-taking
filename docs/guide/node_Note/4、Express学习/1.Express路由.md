## Express

å®˜æ–¹ç®€ä»‹:

> [Express](https://www.expressjs.com.cn/)æ˜¯åŸºäº Node.js å¹³å°ï¼Œå¿«é€Ÿã€å¼€æ”¾ã€æç®€çš„ Web å¼€å‘æ¡†æ¶

åŠŸèƒ½ï¼š

&emsp;&emsp;å¯¹äºå‰ç«¯ç¨‹åºå‘˜æ¥è¯´ï¼Œä½¿ç”¨ Express å¯ä»¥æ–¹ä¾¿ã€å¿«é€Ÿçš„åˆ›å»º==Web ç½‘ç«™æœåŠ¡å™¨==æˆ–è€… ==API æ¥å£æœåŠ¡å™¨==

> web ç½‘ç«™æœåŠ¡å™¨ï¼šä¸“é—¨å¯¹å¤–æä¾› web ç½‘é¡µèµ„æºçš„æœåŠ¡å™¨
> API æ¥å£æœåŠ¡å™¨ï¼šä¸“é—¨å¯¹å¤–æä¾› API æ¥å£çš„æœåŠ¡å™¨

## ä¸€ã€Express å…¥é—¨

ä¸‹è½½ï¼š

```sh
npm i express -S
```

### 1ã€åŸºæœ¬ä½¿ç”¨

â‘  ç®€å•ç¤ºä¾‹ï¼š

```js
const express = require('express')

const app = express()

app.get('/home', (req, res) => {
  // ä¼ ç»Ÿçš„æ–¹å¼
  res.write('é¦–é¡µ')
  res.end()
})

app.get('/login', (req, res) => {
  // expressğŸ’–å°è£…çš„æ–¹å¼ï¼ˆç›´æ¥ä½¿ç”¨send()ï¼‰
  res.send('ç™»å½•')
})

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

â‘¡ send()æ–¹æ³•

åŸç”Ÿ node æ–¹å¼ï¼š

```js
// å¿…é¡»ç”¨jsonå­—ç¬¦ä¸²åŒ…è£¹
res.write(`<html><h2>é¦–é¡µ</h2></html>`)

res.write(`{
  name: 'lencamo',
  age: 21
}`)
```

ç°åœ¨ express æ–¹å¼ï¼š

```js
// ä»£ç ç‰‡æ®µ
res.send('<h2>é¦–é¡µ</h2>')

// jså¯¹è±¡
res.send({
  name: 'lencamo',
  age: 21
})
```

### 2ã€åŸºæœ¬è·¯ç”±

â‘  åŠ¨æ€è·¯å¾„

```js
// è¦ä½¿ç”¨è·¯ç”±å‚æ•°âœ¨å®šä¹‰è·¯ç”±
app.get('/users/:userId/books/:bookId', function (req, res) {
  res.send(req.params)
})

// æ­¤è·¯å¾„å°†åŒ¹é… acd å’Œ abcdã€‚
app.get('/ab?cd', function (req, res) {
  res.send('ab?cd')
})

// æ­¤è·¯å¾„å°†åŒ¹é… abcdã€ abbcdã€ abbbcd ç­‰ã€‚
app.get('/ab+cd', function (req, res) {
  res.send('ab+cd')
})

// æ­¤è·¯å¾„å°†åŒ¹é… abcdã€ abxcdã€ abRANDOMcdã€ ab123cd ç­‰ã€‚
app.get('/ab*cd', function (req, res) {
  res.send('ab*cd')
})
```

> å½“ç„¶è·¯å¾„è¿˜å¯ä»¥æ ¹æ®éœ€æ±‚å†™ æ­£åˆ™è¡¨è¾¾å¼

â‘¡ è·¯ç”±å›è°ƒå‡½æ•°
&emsp;&emsp;å¯ä»¥è¯·æ±‚æä¾›å¤šä¸ªå›è°ƒå‡½æ•°ï¼Œå…¶è¡Œä¸ºç±»ä¼¼äºä¸­é—´ä»¶ã€‚å¹¶ä¸”ï¼Œè¿™äº›å›è°ƒå‡½æ•°å¯ä»¥è°ƒç”¨ `next('route')` æ–¹æ³•ç•¥è¿‡å…¶ä»–è·¯ç”±å›è°ƒå‡½æ•°

```js
app.get(
  '/home',
  // 1ã€ä¸­é—´ä»¶
  (req, res, next) => {
    console.log('éªŒè¯token')
    const isValid = true

    // å¦‚æœéªŒè¯æˆåŠŸï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªè·¯ç”±å›è°ƒå‡½æ•°
    if (isValid) {
      // ğŸš©ï¼ˆè½¬å‘ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼‰
      next()
    } else {
      res.send('Error')
    }
  },
  // 2ã€ä¸­é—´ä»¶
  (req, res) => {
    res.send({ list: [1, 2, 3] })
  }
)
```

> é™¤æ­¤ä¹‹å¤–ï¼Œexpress è¿˜æ”¯æŒå¦ä¸€ç§å†™æ³•ï¼ˆæ•°ç»„ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ä¸å‰è€…éšæ„ç»„åˆã€‚

```js
const cb1 = (req, res, next) => {
  console.log('éªŒè¯token')
  const isValid = true

  if (isValid) {
    next()
  } else {
    res.send('Error')
  }
}

const cb2 = (req, res) => {
  res.send({ list: [1, 2, 3] })
}

app.get('/home', [cb1, cb2])

app.get('/list', [cb1], (req, res) => {
  res.send({ list: [1, 2, 3] })
})
```

â‘¢ æ•°æ®å…±äº«

&emsp;&emsp;<span style="color:red">å¤šä¸ªç»„ä»¶ä¹‹é—´ï¼Œå…±äº«çš„æ˜¯åŒä¸€ä»½ req å’Œ res</span>ã€‚åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œä¸Šæ¸¸çš„ä¸­é—´ä»¶ä¸­çš„è‡ªå®šä¹‰å±æ€§å’Œæ–¹æ³•ï¼Œå¯ä»¥ä¾›ä¸‹æ¸¸çš„ä¸­é—´ä»¶ä½¿ç”¨ã€‚

```js
app.get(
  '/home',
  // ä¸­é—´ä»¶1
  (req, res, next) => {
    res.name = 'lencamo'
    req.age = 21
    next()
  },
  // ä¸­é—´ä»¶2
  (req, res) => {
    console.log(res.name, req.age)
  }
)
```

## äºŒã€Express ä¸­é—´ä»¶

&emsp;&emsp;Express çš„ä¸­é—´ä»¶ï¼Œæœ¬è´¨ä¸Šè®²å°±æ˜¯ä¸€ä¸ª function å¤„ç†å‡½æ•°ã€‚å…¶ä¸­ï¼Œé‡Œé¢çš„ next å‡½æ•°å¯ä»¥å®ç°å¤šä¸ªä¸­é—´ä»¶é—´çš„è¿ç»­è°ƒç”¨ã€‚

æ¯”è¾ƒï¼š

- <span style="color:Skyblue">è·¯ç”±</span>å¤„ç†å‡½æ•°åªåŒ…å« reqã€res
- <span style="color:Skyblue">ä¸­é—´ä»¶</span>å‡½æ•°ä¸­å¿…é¡»åŒ…å« next å‚æ•°

> ä¸­é—´ä»¶è¦æ…é‡ä½¿ç”¨ res.send( )ï¼Œå› ä¸ºä¸€æ—¦å‘é€å“åº”ï¼Œå°±æ„å‘³ç€ç»“æŸäº†ã€‚

åˆ†ç±»ï¼š

- åº”ç”¨çº§ä¸­é—´ä»¶
- è·¯ç”±çº§ä¸­é—´ä»¶
- é”™è¯¯å¤„ç†ä¸­é—´ä»¶
- å†…ç½®ä¸­é—´ä»¶
- ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶

### 1ã€åº”ç”¨çº§ä¸­é—´ä»¶

è¯·æ±‚ç±»å‹(method)ã€è¯·æ±‚åœ°å€(path)ã€å¤„ç†å‡½æ•°(handler)

```JavaScript
app.METHOD(PATH, HANDLER)
```

&emsp;&emsp;é€šè¿‡ <span style="color:green">app.use( )</span> ã€<span style="color:green">app.get( )</span> ã€<span style="color:green">app.post( )</span> ï¼Œç»‘å®šåˆ° <span style="color:red">app å®ä¾‹ä¸Š</span> çš„ä¸­é—´ä»¶ã€‚

> å¯¹äºæœ‰è°ƒç”¨ next( ) å‡½æ•°çš„ä¸­é—´ä»¶ï¼Œè¦æ³¨æ„ä»–ä»¬çš„ä½¿ç”¨ä½ç½®ï¼Œæ‰§è¡Œæ—¶æœ‰é¡ºåºä¹‹åˆ†ã€‚

```js
const express = require('express')

const app = express()

// 1ã€å…¨å±€ä¸­é—´ä»¶
app.use((req, res, next) => {
  console.log('Hello Worldï¼ï¼')
  next()
})

// 2ã€å±€éƒ¨ä¸­é—´ä»¶
const cb = (req, res, next) => {
  console.log('Hello Expressï¼ï¼')
  next()
}

app.get('/login', [cb], (req, res) => {
  console.log('ç™»å½•')
  res.send({ status: 1 })
})

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

### 2ã€è·¯ç”±çº§ä¸­é—´ä»¶

&emsp;&emsp;ä¸åº”ç”¨çº§ä¸­é—´ä»¶ç»‘å®šåˆ° <span style="color:green"> app å®ä¾‹ä¸Š</span> ä¸åŒï¼Œè·¯ç”±çº§ä¸­é—´ä»¶ç»‘å®šåˆ° <span style="color:red">router å®ä¾‹ä¸Š</span> çš„ä¸­é—´ä»¶ã€‚

> ä¸‹é¢ä»¥æ”¹é€ ä¸Šé¢çš„ä¸€ä¸ª token éªŒè¯æ¡ˆä¾‹ä¸ºä¾‹ï¼š

- index.js

```js
const express = require('express')
const loginRouter = require('./router/loginRouter')
const registryRouter = require('./router/registryRouter')

// åˆ›å»ºâœ¨appå®ä¾‹
const app = express()

app.use((req, res, next) => {
  console.log('éªŒè¯token')
  const isValid = true

  if (isValid) {
    next()
  } else {
    res.send('Error')
  }
})

// ğŸš©æ­¤ åº”ç”¨çº§ä¸­é—´ä»¶ è¦è°ƒç”¨ è·¯å¾„çº§ä¸­é—´ä»¶
app.use('/login', loginRouter)
app.use(registryRouter)

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

- loginRouter.js

```js
const express = require('express')

// åˆ›å»ºâœ¨routerå®ä¾‹
const route = express.Router()

// æ ¹æ®è·¯å¾„æ¥åŒ¹é…è¦æ‰§è¡Œçš„å‡½æ•°
// http://127.0.0.1:3000/login/oneè®¿é—®
route.post('/', (req, res) => {
  console.log(req.body)

  const { username, password } = req.body
  if (username === '' && password == '') {
    res.send({ ok: 1 })
  } else {
    res.send({ ok: 0 })
  }
})

module.exports = route
```

- registryRouter.js

```js
const express = require('express')

// åˆ›å»ºâœ¨routerå®ä¾‹
const route = express.Router()

// æ ¹æ®è·¯å¾„æ¥åŒ¹é…è¦æ‰§è¡Œçš„å‡½æ•°
// http://127.0.0.1:3000/registry/twoè®¿é—®
route.get('/registry', (req, res) => {
  res.send('<p>æ¬¢è¿ä½ ï¼Œæ–°ç”¨æˆ·ï¼ï¼</p>')
})

module.exports = route
```

### 3ã€é”™è¯¯çº§ä¸­é—´ä»¶

&emsp;é”™è¯¯çº§ä¸­é—´ä»¶æ˜¯ç”¨æ¥æ•è·é¡¹ç›®å‘ç”Ÿçš„å¼‚å¸¸é”™è¯¯ï¼Œä»è€Œ <span style="color:green">é˜²æ­¢é¡¹ç›®å¼‚å¸¸å´©æºƒ</span>ã€‚

> æ³¨æ„ï¼šé”™è¯¯çº§ä¸­é—´ä»¶å¿…é¡»æ”¾åœ¨æ‰€æœ‰ä¸­é—´ä»¶çš„æœ€åé¢ã€‚

&emsp;&emsp;é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ€»æ˜¯æœ‰å››ä¸ªå‚æ•°ã€‚æ‚¨å¿…é¡»æä¾›å››ä¸ªå‚æ•°æ¥å°†å…¶æ ‡è¯†ä¸ºä¸€ä¸ªé”™è¯¯å¤„ç†ä¸­é—´ä»¶å‡½æ•°

```js
app.get('/', (req, resp) => {
  // æ‰‹åŠ¨åˆ¶é€ é”™è¯¯
  throw new Error('500 æœåŠ¡å™¨å†…éƒ¨å‘ç”Ÿé”™è¯¯ï¼')
  resp.send('success')
})

app.use((err, req, res, next) => {
  console.error(err.stack)
  res.status(500).send('Error!' + err.message)
})
```

### 4ã€å†…ç½®ä¸­é—´ä»¶

&emsp;&emsp;åœ¨ Express4.16.0 ç‰ˆæœ¬å¼€å§‹ä»¥åï¼ŒExpress å†…ç½®äº† `express.static`ã€`express.json`ã€`express.urlencoded` ä¸‰ä¸ªå¸¸ç”¨çš„ä¸­é—´ä»¶ã€‚
&emsp;&emsp;ä½¿ç”¨åœºæ™¯ï¼šâ‘  å¿«é€Ÿæ‰˜ç®¡é™æ€èµ„æºã€â‘¡ è§£æå®¢æˆ·ç«¯é€šè¿‡ post æ–¹å¼å‘æœåŠ¡ç«¯å‘é€<span style='color:skyblue'> JSON æ ¼å¼</span>ã€<span style='color:skyblue'>URL-encoded æ ¼å¼</span>çš„è¯·æ±‚ä½“(body)æ•°æ®ã€‚

### 5ã€ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶

- body-parser

&emsp;&emsp;ä¾‹ï¼šå·²ç»è¢«å¼ƒç”¨çš„ body-parserï¼ˆåœ¨ Express4.16.0 ç‰ˆæœ¬å¼€å§‹ä»¥å‰ï¼Œç»å¸¸ç”¨æ¥è§£æè¯·æ±‚æ•°æ®ï¼‰ã€‚

> npm install body-parser

```JavaScript
// å·²å¼ƒç”¨
const parser = require('body-parser');
app.use(parser.urlencoded({extended: false}))

// ä½¿ç”¨å†…ç½®çš„
const express = require('express');
app.use(express.urlencoded({extended: false}))
```

- cookie-parser

> npm install cookie-parser

```JavaScript
const cookieParser = require('cookie-parser')

app.use(cookieParser())
```

```js
router.get('/', (req, res) => {
  // 1ã€è®¾ç½®Cookie
  // å‰ç«¯ï¼š ğŸš©document.cookie="username=lencamo" çš„æ–¹å¼è®¾ç½®Cookieå†…å®¹
  // åç«¯ï¼šå¦‚ä¸‹
  res.cookie('username', 'lencamo')

  // 2ã€è¯»å–Cookie
  console.log(req.cookies)
  res.send()
})
```

## ä¸‰ã€è·å–è¯·æ±‚æ•°æ®

&emsp;&emsp;å›é¡¾å‰é¢ä½¿ç”¨åŸç”Ÿ Node.js ä»£ç è·å–è¯·æ±‚æ•°æ®æ—¶ï¼Œä¸ä»…è¦å¼•å…¥`fsæ¨¡å—`ï¼Œè¿˜æœ‰`new URL`ï¼Œéå¸¸éº»çƒ¦ã€‚

### 1ã€get è¯·æ±‚

```js
const express = require('express')

const route = express.Router()

route.get('/', (req, res) => {
  // ä½¿ç”¨req.queryâœ¨
  console.log(req.query)
  res.send({ ok: 1 })
})

module.exports = route
```

### 2ã€post è¯·æ±‚

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220417185445.png" width=442px />

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220417185758.png" width=442px />

- index.js

```js
const express = require('express')
const loginRouter = require('./router/loginRouter')

const app = express()

// é…ç½®ğŸš©è§£æpostè¯·æ±‚å‚æ•°çš„ç›¸å…³ å†…ç½®ä¸­é—´ä»¶
// 1ã€application/x-www-form-urlencoded
// urlç¼–ç æ ¼å¼å‚æ•°å¤„ç†ï¼ˆusername=lencamo&age=21ï¼‰
app.use(express.urlencoded({ extended: false }))

// 2ã€application/json
// jsonæ•°æ®æ ¼å¼å‚æ•°å¤„ç†ï¼ˆ{"username":"lencamo","age":21}ï¼‰
app.use(express.json())

app.use((req, res, next) => {
  console.log('éªŒè¯token')
  const isValid = true

  if (isValid) {
    next()
  } else {
    res.send('Error')
  }
})

app.use('/login', loginRouter)

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

- loginRouter

```js
const express = require('express')

const route = express.Router()

route.post('/', (req, res) => {
  // ä½¿ç”¨req.bodyâœ¨
  console.log(req.body)
  res.send({ ok: 1 })
})

module.exports = route
```

## å››ã€é™æ€èµ„æºç®¡ç†

&emsp;&emsp;å›é¡¾å‰é¢ä½¿ç”¨åŸç”Ÿ Node.js ä»£ç å¯¹é™æ€èµ„æºè¿›è¡Œå¤„ç†æ—¶ï¼Œè¦å¯¹è‡ªå®šä¹‰çš„è·¯ç”±è¿›è¡Œå¾ˆå¤šå¤æ‚çš„å¤„ç†ï¼Œéå¸¸éº»çƒ¦ã€‚

> ä»¥å‰æˆ‘ä»¬æµ‹è¯•æ˜¯æ—¶å€™å°†é™æ€èµ„æºæ”¾åœ¨äº† static æ–‡ä»¶å¤¹ä¸­ï¼Œç°åœ¨æ¨èä½¿ç”¨è§„èŒƒçš„ public æ–‡ä»¶å¤¹ã€‚

```js
const express = require('express')

const app = express()

// å¯¹é™æ€èµ„æºçš„å¤„ç†ğŸ‘ï¼ˆç®€å•ï¼‰
// 1ã€å¸¸è§„
app.use(express.static('./public'))
// 2ã€æŒ‚è½½è®¿é—®å‰ç¼€
app.use('/ren', express.static('./public'))

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

&emsp;&emsp;é€šè¿‡ä¸Šé¢çš„é…ç½®åï¼Œpublic å†…çš„é™æ€èµ„æºå°±å¯ä»¥åƒåœ¨ä»¥å‰ä¸€æ ·åœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤ºã€‚

åŠ¨æ‰‹å®è·µï¼š

> ä½¿ç”¨ Express è·¯ç”±é‡æ„ä¸€ä¸‹å‰é¢å†™çš„ Node è·¯ç”±æ¡ˆä¾‹ã€‚

## äº”ã€Express ç”Ÿæˆå™¨

&emsp;&emsp;Express ç”Ÿæˆå™¨æ˜¯ç”¨äº<span style="color:green;">å¿«é€Ÿåˆ›å»ºåº”ç”¨ç¨‹åºéª¨æ¶</span>ã€‚å’Œä»¥å‰å­¦ä¹ çš„`vue-cli`ä¸€æ ·ï¼Œéœ€è¦å…¨å±€å®‰è£…ã€‚

```sh
1ã€vueéª¨æ¶ï¼š
å®‰è£…
npm i @vue/cli -g
åˆ›å»º
vue create <projectName>

2ã€expresséª¨æ¶
å®‰è£…
npm i express-generator -g
åˆ›å»ºï¼ˆé»˜è®¤æ˜¯åŸºäºjadeæ¨¡æ¿å¼•æ“ï¼‰
express <projectName>
express <projectName> --view=ejs
```

å¯åŠ¨ express é¡¹ç›®ï¼š

```sh
cd <projectName>
npm i
npm run start
```

é…ç½® package.json æ¥è®© express å¯ä»¥é‡å¯æœåŠ¡å™¨ï¼š

```json
{
  "scripts": {
    "start": "nodemom ./bin/www"
  }
}
```

### é¡¹ç›®ç»“æ„

```
<projectName>
â”œâ”€ app.js
â”œâ”€ bin
â”‚  â””â”€ www ğŸš©
â”œâ”€ package.json
â”œâ”€ public
â”‚  â”œâ”€ images
â”‚  â”œâ”€ javascripts
â”‚  â””â”€ stylesheets
â”‚     â””â”€ style.css
â”œâ”€ routes
â”‚  â”œâ”€ index.js
â”‚  â””â”€ users.js
â””â”€ views
   â”œâ”€ error.ejs
   â””â”€ index.ejs
```

### é»˜è®¤ä¾èµ–

```json
{
  "dependencies": {
    "cookie-parser": "~1.4.4",
    "debug": "~2.6.9",
    "ejs": "~2.6.1",
    "express": "~4.16.1",
    "http-errors": "~1.6.3",
    "morgan": "~1.9.1"
  }
}
```
