&emsp;&emsp;å¯¹äºæœåŠ¡ç«¯æ¸²æŸ“å’Œå‰åç«¯åˆ†ç¦»ä¸¤ç§å¼€å‘æ¨¡å¼ï¼Œåˆ†åˆ«æœ‰ç€ä¸åŒçš„èº«ä»½è®¤è¯æ–¹æ¡ˆï¼š

- <span style="color:green">æœåŠ¡ç«¯æ¸²æŸ“</span>æ¨èä½¿ç”¨ <span style="color:red">Session è®¤è¯æœºåˆ¶</span>
- <span style="color:green">å‰åç«¯åˆ†ç¦»</span>æ¨èä½¿ç”¨ <span style="color:red">JWT è®¤è¯æœºåˆ¶</span> ï¼ˆä½¿ç”¨ä¾æ®ï¼šSession è®¤è¯éœ€è¦é…åˆ Cookieï¼Œè€Œ Cookie é»˜è®¤ä¸æ”¯æŒè·¨åŸŸè®¿é—®ï¼‰

## ä¸€ã€Session è®¤è¯æœºåˆ¶

### 1ã€HTTP çš„æ— çŠ¶æ€æ€§

&emsp;&emsp;ç”±äº HTTP åè®®çš„æ— çŠ¶æ€æ€§ï¼ˆå®¢æˆ·ç«¯çš„æ¯æ¬¡ HTTP è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸»åŠ¨ä¿ç•™ HTTP è¯·æ±‚çš„çŠ¶æ€ï¼‰ã€‚

### 2ã€Cookie

&emsp;&emsp;ä¸ºäº†åŒºåˆ†ä¸åŒçš„è¯·æ±‚ï¼Œåœ¨ Web ä¸­æœ‰æˆ‘ä»¬é€šå¸¸ä¼šæ¥è§¦åˆ° Cookieï¼Œé€šè¿‡å®ƒå®ç°çš„è®¤è¯æ–¹å¼ç±»ä¼¼äºè¶…å¸‚ã€å•†åœºä¸­çš„`ä¼šå‘˜å¡`ã€‚

â‘  ç®€ä»‹

&emsp;&emsp;Cookie æ˜¯å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­çš„ä¸è¶…è¿‡ 4kb çš„å­—ç¬¦ä¸²ã€‚ç”± <span style="color:skyblue">å†…å®¹(é”®å€¼å¯¹) + å…¶ä»–å¯é€‰å±æ€§ç»„æˆ(æœ‰æ•ˆæœŸã€å®‰å…¨æ€§ã€ä½¿ç”¨èŒƒå›´)</span>

```js
router.get('/', (req, res) => {
  // 1ã€è®¾ç½®Cookie
  res.cookie('username', 'lencamo')

  // 2ã€è¯»å–Cookie
  console.log(req.cookies)
  res.send()
})
```

â‘¡ é—®é¢˜

&emsp;&emsp;ç”±äºæµè§ˆå™¨ä¹Ÿæä¾›äº†è¯»å†™ Cookie çš„ APIï¼Œæ‰€ä»¥ Cookie å¾ˆå®¹æ˜“è¢«ä¼ªé€ ï¼ˆå®‰å…¨æ€§æœ‰å¾…è€ƒé‡ï¼‰ã€‚

```js
// 1ã€è®¾ç½®Cookie
document.cookie = 'username=lencamo'

// 2ã€è¯»å–Cookie
javascript: alert(document.cookie)
// ã€å½“ç„¶è¿˜å¯ä»¥é€šè¿‡ å¼€å‘è€…å·¥å…·çš„Applicationã€æµè§ˆå™¨åœ°å€å‰çš„å›¾æ ‡ã€‘
```

### 3ã€Session

&emsp;&emsp;å•ç‹¬ä½¿ç”¨ Cookie æ—¶ï¼Œç”±äºæµè§ˆå™¨è€Œé€ æˆä¸€äº›å®‰å…¨é—®é¢˜ã€‚å¯¹åº”çš„è§£å†³æ–¹æ¡ˆä¸ºï¼š`ä¼šå‘˜å¡` + `åˆ·å¡æœºè®¤è¯`ã€‚

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220626131424.png" width=541px />

&emsp;&emsp;ä½¿ç”¨ express-session åŒ…åï¼Œç›¸å…³çš„éªŒè¯ã€è®¾ç½® cookie ç­‰æ“ä½œå°†è‡ªè¿›è¡Œï¼Œä¸ç”¨è‡ªå·±ç¼–å†™ã€‚æµè§ˆå™¨ä¼šè‡ªåŠ¨å¸¦æœ‰ cookie ç»™åç«¯ï¼Œåç«¯ä¼šè‡ªåŠ¨çš„å¯¹å…¶è¿›è¡Œæ ¡éªŒã€‚

â‘  é‡ç‚¹

- Cookie å­˜å‚¨åœ¨å®¢æˆ·ç«¯
- Session å­˜å‚¨åœ¨æœåŠ¡ç«¯çš„å†…å­˜ä¸­ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥å­˜åœ¨æ•°æ®åº“ä¸­ï¼‰

â‘¡ é…ç½®

```sh
npm i express-session
# npm i connect-mongo
```

- app.js

```js
// å¯¼å…¥sessionä¸­é—´ä»¶
const session = require('express-session')
// const MongoStore = require('connect-mongo')

// æ³¨å†Œsessionä¸­é—´ä»¶
app.use(
  session({
    // 1ã€sessionåŸºç¡€é…ç½®
    name:'test-session'
    secret: 'keyboard cat',
    resave: true, //ä»æœªè®¿é—®çš„æ—¶é—´ç‚¹å¼€å§‹è®¡æ—¶
    saveUninitialized: true,
    cookie: {
      maxAge:1000*60*60 //è¿‡æœŸæ—¶é—´
      secure: true //ä¸ºtrueæ—¶ï¼Œåªæœ‰httpsåè®®æ‰èƒ½è®¿é—®cookie
    }
    // 2ã€é…ç½®å­˜å‚¨âœ¨sessionçš„æ•°æ®åº“
    // store: MongoStore.create({
    //   mongourl: 'mongodb://127.0.0.1/ren_Session',
    //   ttl: 1000*60*10 //è¿‡æœŸæ—¶é—´
    // })
  })
)

// ç¼–å†™ç™»å½•åçš„ï¼šsessionè¿‡æœŸğŸš©æ ¡éªŒçš„ä¸­é—´ä»¶
app.use((req,res,next)=>{
  if(req.url.includes('login')){
    next()
    return
  }
  if(req.session.user){
    req.session.mydate = Date.now() //é‡ç½®sessionå€¼
    next()
  }else{
    // åå°çš„ä¸€äº›apiè¯·æ±‚ï¼ˆè¿”å›é”™è¯¯ç  â€”â€”> å‰ç«¯çš„axiosæ‹¦æˆªå™¨å¤„ç†?ï¼‰ã€æ¨¡å—æ¸²æŸ“ğŸš©ï¼ˆé‡å®šå‘ï¼‰
    req.url.includes('api')?res.status(401).send({ok:0}):res.redirect('/login')
  }
})

app.use('/backend',indexRouter)
app.use('/api',usersRouter) //å‰åç«¯åˆ†ç¦»ï¼šæ¥å£æ•°æ®
app.use('/login',loginRouter) //æ¨¡æ¿æ¸²æŸ“ï¼šé¡µé¢å†…å®¹
```

### 4ã€ç™»å½•åå°é¡µé¢(backend)æ¡ˆä¾‹æ¼”ç¤º

â‘  é¡µé¢

- views/login.ejs

```js
<body>
  â€¦â€¦

  <script>
    login.onclick = () => {
      fetch('/api/login',{
        method: 'POST',
        body: JSON.stringify({
          username: username.value,
          password: password.value
        }),
        headers: {
          "Content-Type": "application/json"
        }
      })
        .then((res) => res.json())
        .then((res) => {
          if (res.ok === 1) {
            location.href = '/backend'
          }else{
            alert('ç”¨æˆ·åå¯†ç ä¸åŒ¹é…ï¼ï¼')
          }
        })
    }
  </script>
<body>
```

- views/backend.ejs

```html
<body>
  <h2>åå°ç³»ç»Ÿ-ç”¨æˆ·ç®¡ç†ä¸šåŠ¡</h2>
  â€¦â€¦
  <button id="exit">é€€å‡ºç™»å½•</button>

  <script>

    â€¦â€¦ //æ‰€æœ‰çš„è¯·æ±‚éƒ½è¦åŠ ifåå†…å®¹ğŸ¤”

    exit.onclick = () => {
      fetch('/api/logout')
        .then((res) => res.json())
        .then((res) => {
          if (res.ok === 1) {
            location.href = '/login'
          }
        })
    }
  </script>
</body>
```

â‘¡ ä»£ç æ¼”ç¤º

- routes/backend.js

```js
router.get('/', function (req, res, next) {
  // åˆ¤æ–­æ˜¯å¦æœ‰âœ¨è®¾ç½®å¥½çš„Cookie
  if (req.session.user) {
    // è½¬åˆ°backend.ejsæ¨¡æ¿é¡µé¢
    res.render('backend', { title: 'Express' })
  } else {
    res.redirect('/login')
  }
})
```

- routes/login.js

```js
router.get('/', function (req, res, next) {
  // è½¬åˆ°login.ejsæ¨¡æ¿é¡µé¢
  res.render('login', { title: 'Express' })
})
```

- routes/users.js

```js
// ç™»å½•æ ¡éªŒ
router.post('/login', UserController.login)

//é”€æ¯âœ¨session(é€€å‡ºç™»å½•)
router.post('/logout', (req, res) => {
  req.session.destroy(() => {
    res.send({ ok: 1 })
  })
})
```

- controllers/UserController.js

```js
const UserController = {
  login: async (req, res) => {
    const { username, password } = req.body
    const data = await UserService.login(username, password)

    if (data.length === 0) {
      res.send({
        ok: 0
      })
    } else {
      // è‹¥æŸ¥åˆ°å­˜åœ¨è¯¥ç”¨æˆ·åˆ™ï¼šè®¾ç½®âœ¨Sessionå¯¹è±¡
      req.session.user = req.body //req.bodyä»…ä»…èµ·æ ‡è¯†ä½œç”¨ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºå…¶ä»–æ•°æ®
      res.send({
        ok: 1
      })
    }
  }
}

module.exports = UserController
```

- services/UserService.js

```js
const UserModel = require('../model/UserModel')

const UserService = {
  login: (username, password) => {
    return UserModel.find({
      username,
      password
    })
  }
}

module.exports = UserService
```

## äºŒã€JWT è®¤è¯æœºåˆ¶

&emsp;&emsp;å½“ç„¶ä¸Šé¢çš„ Session è®¤è¯æœºåˆ¶ä¹Ÿä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹ï¼š

- å ç”¨å†…å­˜/ç©ºé—´
- è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRF æ”»å‡»ï¼‰
- â€¦â€¦

&emsp;&emsp;æ—¢ç„¶åœ¨ Application ä¸­çš„ Cookies å’Œ Session Storage ä¸è¡Œï¼ˆä¸å®‰å…¨ã€å ç©ºé—´ï¼‰ï¼Œé‚£ç›´æ¥å°†ä¿¡æ¯å­˜åˆ° Application ä¸­çš„ Local Storage ä¸­ï¼Œå¹¶ä¸”å¯¹ä¿¡æ¯è¿›è¡Œ HMAC-SHA256 åŠ å¯†å¤„ç†ã€‚

### 1ã€JWT

&emsp;&emsp;JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆã€‚ç”±å®ƒçš„å…¨ç§°å¯ä»¥çŸ¥é“ï¼šå®ƒèƒ½å°†å„éƒ¨åˆ†çš„ JSON ç”Ÿæˆ Token å­—ç¬¦ä¸²ã€‚

```sh
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
```

â‘  ç®€ä»‹ï¼š

&emsp;&emsp;JWT å­—ç¬¦ä¸²é€šå¸¸ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šheaderï¼ˆå¤´éƒ¨ï¼Œæ ‡è¯†ï¼ŒåŠ å¯†æ–¹å¼ï¼‰ã€payloadï¼ˆè´Ÿè½½ï¼Œå°±æ˜¯ç”¨æˆ·æ•°æ®ï¼‰ã€secretï¼ˆå¯†é’¥ï¼‰

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220627114648.png" width=509px />

â‘¡ ç¼ºç‚¹ï¼š

- ç­¾åï¼ˆtokenï¼‰å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨çš„ Application ä¸­çš„ Local Storage ä¸­ç›´æ¥æ‹¿åˆ° ğŸ¤”ã€‚
- ç”±äºä¿¡æ¯å­˜å‚¨åœ¨æµè§ˆå™¨ï¼Œç›¸åº”çš„ä¼šå æœ‰æ›´å¤šçš„å¸¦å®½ï¼ˆæµé‡ï¼‰ã€‚
- token æ— æ³•åœ¨æœåŠ¡ç«¯æ³¨é”€ï¼Œå¯¹åº”çš„é‡åˆ°åŠ«æŒé—®é¢˜æ—¶ä¼šç›¸å½“æ£˜æ‰‹ã€‚

### 2ã€ä»£ç æ¼”ç¤º

â‘  ä¸‹è½½

```sh
npm i jsonwebtoken
```

â‘¡ å°è£…ä¸€ä¸ªæ¨¡å—

- util/JWT.js

```js
const jwt = require('jsonwebtoken')

const secret = '<ç§˜é’¥>'
const JWT = {
  // 1ã€ç”Ÿæˆtokenå­—ç¬¦ä¸²
  generate(value, expires) {
    // ä½¿ç”¨signå‡½æ•°
    return jwt.sign(
      {
        // data: '<æ•°æ®>'
        data: value
      },
      secret,
      {
        // expiresIn: '<æœ‰æ•ˆæœŸ>'
        expiresIn: expires
      }
    )
  },

  // 2ã€è§£å¯†æ•°æ®
  verify() {
    try {
      return jwt.verify(token, secret)
    } catch (error) {
      return false
    }
  }
}

module.exports = JWT
```

â‘¢ ä½¿ç”¨

- routes/backend.js

```js
const token = JWT.generate({ name: 'lencamo' }, '10s')

setTimeout(() => {
  var decoded = jwt.verify(token, '<ç§˜é’¥>')
  console.log(decoded)
}, 8000)
```

### 3ã€ç™»å½•åå°é¡µé¢(backend)æ¡ˆä¾‹æ¼”ç¤º

- app.js

```js
// ğŸš©æ ¡éªŒtokençš„ä¸­é—´ä»¶
app.use((req, res, next) => {
  if (req.url.includes('login')) {
    next()
    return
  }

  // æ€è€ƒï¼ŸES6è¯­æ³•
  // const token = req.headers['authorization'] && req.headers['authorization'].split(" ")[1]
  const token = req.headers['authorization']?.split(' ')[1]

  if (token) {
    const payload = JWT.verify(token)
    if (payload) {
      // é‡æ–°è®¡ç®—tokenâœ¨è¿‡æœŸæ—¶é—´ï¼ˆä»¥æœ€åä¸€æ¬¡ç¦»å¼€çš„æ—¶é—´ä¸ºå‡†ï¼‰
      const newToken = JWT.generate(
        {
          // è®¾ç½®è¦å­˜å‚¨åˆ°tokençš„æ•°æ®
          _id: payload._id,
          username: payload.username,
          password: payload.password
        },
        '2h'
      )
      res.header('Authorization', newToken)

      next()
    } else {
      res.status(401).send({ errCode: -1, errInfo: 'tokenè¿‡æœŸ' })
    }
  } else {
    next()
  }
})

app.use('/backend', indexRouter)
app.use('/api', usersRouter) //å‰åç«¯åˆ†ç¦»ï¼šæ¥å£æ•°æ®
app.use('/login', loginRouter) //æ¨¡æ¿æ¸²æŸ“ï¼šé¡µé¢å†…å®¹
```

â‘  é¡µé¢

&emsp;&emsp;æ‰€ä»¥é¡µé¢éƒ½ä½¿ç”¨ axiosï¼Œå¹¶æ­é… axios æ‹¦æˆªå™¨

- views/login.ejs

```html
<head>
  <script>
    axios.interceptors.request.use(
      function (config) {
        // åœ¨å‘é€è¯·æ±‚ä¹‹å‰åšäº›ä»€ä¹ˆ
        // å‘æœåŠ¡ç«¯å‘é€tokenâœ¨(æ ¡éªŒä½¿ç”¨)
        const token = localStorage.getItem('token')
        config.headers.Authorization = `Bearer ${token}`

        return config
      },
      function (error) {
        return Promise.reject(error)
      }
    )

    // æ·»åŠ å“åº”æ‹¦æˆªå™¨
    axios.interceptors.response.use(
      function (response) {
        // 2xx èŒƒå›´å†…çš„çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°
        // å®¢æˆ·ç«¯æ¥æ”¶âœ¨token
        console.log(response.headers)
        const { authorization } = response.headers
        authorization && localStorage.setItem('token', authorization)

        return response
      },
      function (error) {
        if (err.response.status === 401) {
          localStorage.removeItem('token')
          localtion.href = '/login'
        }

        return Promise.reject(error)
      }
    )
  </script>
</head>
<body>
  â€¦â€¦
  <script>
    login.onclick = () => {
      aixos
        .post('/api/login', {
          username: username.value,
          password: password.value
        })
        .then((res) => {
          // console.log(res.data)
          // console.log(res.headers)
          if (res.ok === 1) {
            location.href = '/backend'
          } else {
            alert('ç”¨æˆ·åå¯†ç ä¸åŒ¹é…ï¼ï¼')
          }
        })
    }
  </script>
</body>
```

- views/backend.ejs

```html
<body>
  <h2>åå°ç³»ç»Ÿ-ç”¨æˆ·ç®¡ç†ä¸šåŠ¡</h2>
  â€¦â€¦
  <button id="exit">é€€å‡ºç™»å½•</button>

  <script>
    // ç§»é™¤âœ¨token
    exit.onclick = () => {
      localStorage.removeItem('token')
      localtion.href = '/login'
    }
  </script>
</body>
```

â‘¡ ä»£ç æ¼”ç¤º

- routes/backend.js

```js
router.get('/', function (req, res, next) {
  // è½¬åˆ°backend.ejsæ¨¡æ¿é¡µé¢
  res.render('backend', { title: 'Express' })
})
```

- routes/login.js

```js
router.get('/', function (req, res, next) {
  // è½¬åˆ°login.ejsæ¨¡æ¿é¡µé¢
  res.render('login', { title: 'Express' })
})
```

- routes/users.js

```js
// ç™»å½•æ ¡éªŒ
router.post('/login', UserController.login)
```

- controllers/UserController.js

```js
const UserController = {
  login: async (req, res) => {
    const { username, password } = req.body
    const data = await UserService.login(username, password)

    if (data.length === 0) {
      res.send({
        ok: 0
      })
    } else {
      // è‹¥æŸ¥åˆ°å­˜åœ¨è¯¥ç”¨æˆ·åˆ™ï¼šæœåŠ¡ç«¯è®¾ç½®ğŸš©token
      const token = JWT.generate(
        {
          // è®¾ç½®è¦å­˜å‚¨åˆ°tokençš„æ•°æ®
          _id: data[0]._id,
          username: data[0].username,
          password: data[0].password
        },
        '2h'
      )

      // åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼šæ¨èâœ¨å°†tokenæ”¾åœ¨headerä¸­ã€‚
      res.header('Authorization', token)

      res.send({
        ok: 1
      })
    }
  }
}

module.exports = UserController
```

- services/UserService.js

```js
const UserModel = require('../model/UserModel')

const UserService = {
  login: (username, password) => {
    return UserModel.find({
      username,
      password
    })
  }
}

module.exports = UserService
```
