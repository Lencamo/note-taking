## Koa

å®˜æ–¹ç®€ä»‹:

> [Koa](https://koajs.com/)æ˜¯åŸºäº Node.js å¹³å°çš„ä¸‹ä¸€ä»£ Web å¼€å‘æ¡†æ¶ã€‚

> ç”± Express å¹•åçš„åŸç­äººé©¬æ‰“é€ ï¼Œ è‡´åŠ›äºæˆä¸º web åº”ç”¨å’Œ API å¼€å‘é¢†åŸŸä¸­çš„ä¸€ä¸ªæ›´å°ã€æ›´å¯Œæœ‰è¡¨ç°åŠ›ã€æ›´å¥å£®çš„åŸºçŸ³

æ›´è½»é‡ï¼š

- koa ä¸æä¾›å†…ç½®ä¸­é—´ä»¶
- koa ä¸æä¾›è·¯ç”±ï¼Œè€Œæ˜¯å°†è·¯ç”±è¿™ä¸ªåº“åˆ†ç¦»å‡ºæ¥äº†ï¼ˆkoa/routerï¼‰

å¼‚æ­¥å¤„ç†ï¼š

&emsp;&emsp;express é‡‡ç”¨ callback æ¥å¤„ç†å¼‚æ­¥ï¼ŒKoa1 é‡‡ç”¨ generatorï¼ŒKoa2 é‡‡ç”¨ asyn/awaitã€‚

> å…¶ä¸­ï¼Œgenerator å’Œ async/await ä½¿ç”¨åŒæ­¥çš„å†™æ³•æ¥å¤„ç†å¼‚æ­¥ï¼Œæ˜æ˜¾å¥½äº callback å’Œ promiseã€‚

## ä¸€ã€Koa å…¥é—¨

ä¸‹è½½ï¼š

```sh
npm i koa -S
```

### 1ã€åŸºæœ¬ä½¿ç”¨

â‘  ç®€å•ç¤ºä¾‹ï¼š

```js
const Koa = require('koa')

const app = Koa()

// ğŸš©ctx === contextä¸Šä¸‹æ–‡
app.use((ctx, next) => {
  // ctx.response
  // ctx.require
  ctx.response.body = 'hello world, Koa2!!'

  // å½“ç„¶å’Œexpressçš„res.send()ä¸€æ ·ï¼Œæ”¯æŒä»£ç ç‰‡æ®µ
  ctx.response.body = '<b>é¦–é¡µ</b>'
  ctx.response.body = {
    name: 'lencamo',
    age: 21
  }
})

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

â‘¡ å®˜æ–¹ç®€å†™å½¢å¼

<img src="https://deer-sir.oss-cn-chengdu.aliyuncs.com/note-taking/20220628173340.png" width=435px />

### 2ã€ä¸­é—´ä»¶æ¨¡

&emsp;&emsp;express åŸºäº connect ä¸­é—´ä»¶ï¼Œä¸ºçº¿æ€§æ¨¡å‹ï¼›

&emsp;&emsp;koa ä¸­é—´ä»¶é‡‡ç”¨çš„æ˜¯æ´‹è‘±æ¨¡å‹ã€‚

> åŒæ­¥æ“ä½œæ—¶ï¼Œæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼›ä½†æ¶‰åŠå¼‚æ­¥æ“ä½œæ—¶ï¼Œkoa è¦æ‰€ä»¥ async/await

## äºŒã€Koa ä¸è·¯ç”±

&emsp;&emsp;Koa ä¸­æ²¡æœ‰é›†æˆè·¯ç”±ï¼Œè¦å•ç‹¬å®‰è£…ï¼š

```sh
npm i koa-router
```

ç®€å•ç¤ºä¾‹ï¼š

- index.js

```js
const Koa = require('koa')

const app = Koa()

const router = require('./routes/index.js')

// 2ã€æ³¨å†Œåº”ç”¨çº§ç»„ä»¶
app.use(router.routes()).use(router.allowedMethods())

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

- routes/index.js

```js
const Router = requrie('koa-router')
const listRouter = require('./list.js')

const router = new Router()

// 1ã€æ³¨å†Œè·¯ç”±çº§ç»„ä»¶
router.use('/list', userRouter.routes(), userRouter.allowedMethods())

// é‡âœ¨å®šå‘
router.redirect('/', 'list')

module.exports = router
```

- routes/list.js

```js
// é“¾å¼âœ¨å†™æ³•
// 1ã€listæ¥å£
router
  .post('/', (ctx, next) => {
    ctx.body = {
      ok: 1,
      info: 'add list success'
    }
  })
  .put('/:id', (ctx, next) => {
    ctx.body = {
      ok: 1,
      info: 'add list success'
    }
  })
  .delete('/:id', (ctx, next) => {
    ctx.body = {
      ok: 1,
      info: 'add list success'
    }
  })
  .get('/', (ctx, next) => {
    ctx.body = ['è‹¹æœ', 'è”æ', 'è¥¿ç“œ']
  })

module.exports = router
```

## ä¸‰ã€æ›´å¤š

### 1ã€é™æ€èµ„æº

å®‰è£…ï¼š

```sh
npm i koa-static
```

ä½¿ç”¨ï¼š

- index.js

```js
const Koa = require('koa')

const path = require('path')
const static = require('koa-static')

const app = new Koa()

// åŠ è½½é™æ€èµ„æº
app.use(static(path.join(__dirname, 'public')))

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

### 2ã€è¯·æ±‚å‚æ•°

å®‰è£…ï¼š

```sh
npm i koa-bodyparser
```

ä½¿ç”¨ï¼š

- index.js

```js
const Koa = require('koa')

const bodyParser = require('koa-bodyparser')

const app = new Koa()

// æ³¨å†Œä¸­é—´ä»¶
app.use(bodyParser())
```

- routes/user.js

```js
// 1ã€getè¯·æ±‚
router.get('/',(ctx, next){
  console.log(ctx.query)
  console.log(ctx.querystring)
  ctx.body={
    ok: 1
  }
})

// 2ã€å…¶ä»–âœ¨è¯·æ±‚ï¼ˆå¿…é¡»ä¾èµ–koa-bodyparseråŒ…ï¼‰
router.post('/',(ctx, next){
  console.log(ctx.request.body)
  ctx.body={
    ok: 1
  }
})
```

### 3ã€ejs æ¨¡æ¿å¼•æ“

å®‰è£…ï¼š

```sh
# æ¨¡æ¿æ–‡ä»¶å¤¹
npm i koa-views
# æ¨¡æ¿å¼•æ“
npm i ejs
```

ä½¿ç”¨ï¼š

- index.js

```js
const Koa = require('koa')

const path = require('path')
const views = require('koa-views')

const app = new Koa()

// åŠ è½½æ¨¡æ¿å¼•æ“
app.use(
  views(path.join(__dirname, 'views'), {
    extension: 'ejs'
  })
)

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

- routes/home.js

```js
const Router = require('koa-router')
const router = new Router()

router.get('/', async (ctx, next) => {
  // ä¼ ç»Ÿ
  // ctx.body = `<html><h2>æ¬¢è¿æ¥åˆ°é¦–é¡µï¼</h2></html>`

  // ä½¿ç”¨æ¨¡æ¿å¼•æ“ï¼ˆæ³¨æ„ï¼šå¿…é¡»ä½¿ç”¨ğŸš©å¼‚æ­¥æ¥ç­‰å¾…æ¨¡æ¿å¼•æ“åŠ è½½å®Œæˆï¼‰
  await ctx.render('home', { username: 'lencamo' })
})

module.exports = router
```

- views/home.ejs

```html
<body>
  <h2>æ¬¢è¿æ¥åˆ°é¦–é¡µï¼<%= username%></h2>
</body>
```
