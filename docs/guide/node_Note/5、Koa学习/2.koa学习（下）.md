## å››ã€Koa ä¸ç™»å½•é‰´æƒ

### 1ã€cookie ä¸ session

â‘  cookie ä½¿ç”¨

```js
const Router = require('koa-router')
const router = new Router()

router.get('/', async (ctx, next) => {
  //è·å–cookie
  console.log(ctx.cookies)
  console.log(ctx.cookies.get('password'))

  // è®¾ç½®cookie
  console.log(ctx.cookies.set('username', 'lencamo'))
})

module.exports = router
```

â‘¡ session ä½¿ç”¨

å®‰è£…ï¼š

```sh
npm i koa-session-minimal
```

ä½¿ç”¨ï¼š

- index.js

```js
const Koa = require('koa')

const views = require('koa-session-minimal')

const app = new Koa()

// sessioné…ç½®
app.use(
  session({
    key: 'lencamoSessionID',
    cookie: {
      maxAge: 1000 * 60 * 60
    }
  })
)

// sessionâœ¨åˆ¤æ–­æ‹¦æˆª
app.use(async (ctx, next) => {
  if (ctx.url.includes('login')) {
    await next()
    return
  }

  if (ctx.session.user) {
    // é‡ç½®è¿‡æœŸæ—¶é—´
    ctx.session.mydate = Date.now()
    await next()
  } else {
    ctx.redirect('/login')
  }
})

app.listen(3000, '127.0.0.1', function () {
  console.log('Server running at http://127.0.0.1:3000')
})
```

- routes/user.js

```js
const Router = require('koa-router')
const router = new Router()

router.post('/login', (ctx, next) => {
  const {username, password} = ctx.request.body

  if(username==="lencamo" && password==="123"){
    // è®¾ç½®ğŸš©sessionï¼ˆéšä¾¿èµ‹äºˆä¸€ä¸ªå€¼ï¼‰
    ctx.session.user = {
      username: 'lencamo'
    }
    ctx.body = {
      ok: 1
    }
  }else{
    ctx.body = {
      ok: 0
    }
  }

  await ctx.render('home', { username: 'lencamo' })
})

module.exports = router
```

### 2ã€JWT

&emsp;&emsp;æ€»çš„æ¥è¯´ï¼Œé€»è¾‘ä¸Šå’Œå‰é¢ express ä¸­ä½¿ç”¨ JWT æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯è¯­æ³•ä¸Šæœ‰äº›è®¸å·®åˆ«ç½¢äº†ï¼ˆctxã€async/awaitï¼‰ã€‚

å®‰è£…ï¼š

```sh
npm i jsonwebtoken
```

ä½¿ç”¨ï¼š

- util/JWT.js

```js
const jwt = require('jsonwebtoken')

const secret = '<ç§˜é’¥>'
const JWT = {
  // 1ã€ç”Ÿæˆtokenå­—ç¬¦ä¸²
  generate(value, expires) {
    // ä½¿ç”¨signå‡½æ•°
    return jwt.sign(
      {
        // data: '<æ•°æ®>'
        data: value
      },
      secret,
      {
        // expiresIn: '<æœ‰æ•ˆæœŸ>'
        expiresIn: expires
      }
    )
  },

  // 2ã€è§£å¯†æ•°æ®
  verify() {
    try {
      return jwt.verify(token, secret)
    } catch (error) {
      return false
    }
  }
}

module.exports = JWT
```

- index.js

```js
// ğŸš©æ ¡éªŒtokençš„ä¸­é—´ä»¶
app.use(async (ctx, next) => {
  if (req.url.includes('login')) {
    await next()
    return
  }

  // æ€è€ƒï¼ŸES6è¯­æ³•
  // const token = req.headers['authorization'] && req.headers['authorization'].split(" ")[1]
  const token = ctx.headers['authorization']?.split(' ')[1]

  if (token) {
    const payload = JWT.verify(token)
    if (payload) {
      // é‡æ–°è®¡ç®—tokenâœ¨è¿‡æœŸæ—¶é—´ï¼ˆä»¥æœ€åä¸€æ¬¡ç¦»å¼€çš„æ—¶é—´ä¸ºå‡†ï¼‰
      const newToken = JWT.generate(
        {
          // è®¾ç½®è¦å­˜å‚¨åˆ°tokençš„æ•°æ®
          _id: payload._id,
          username: payload.username
        },
        '2h'
      )
      ctx.set('Authorization', newToken)

      await next()
    } else {
      ctx.status(401)
      ctx.body = { errCode: -1, errInfo: 'tokenè¿‡æœŸ' }
    }
  } else {
    await next()
  }
})
```

- routes/user.js

```js
const Router = require('koa-router')
const router = new Router()

router.post('/login', (ctx, next) => {
  const {username, password} = ctx.request.body

  if(username==="lencamo" && password==="123"){
    // åœ¨æœåŠ¡ç«¯è®¾ç½®è®¾ç½®ğŸš©header
    const token = JWT.generate({
      _id: '65462fdq'
      username: 'lencamo'
    }, '2h')

    // tokenè¿”å›åˆ°âœ¨headerä¸Š
    ctx.set('Authorization', token)

    ctx.body = {
      ok: 1
    }
  }else{
    ctx.body = {
      ok: 0
    }
  }

  await ctx.render('home', { username: 'lencamo' })
})

module.exports = router
```

- views/login.ejs

```html
<head>
  <script>
    axios.interceptors.request.use(
      function (config) {
        // åœ¨å‘é€è¯·æ±‚ä¹‹å‰åšäº›ä»€ä¹ˆ
        // å‘æœåŠ¡ç«¯å‘é€tokenâœ¨(æ ¡éªŒä½¿ç”¨)
        const token = localStorage.getItem('token')
        config.headers.Authorization = `Bearer ${token}`

        return config
      },
      function (error) {
        return Promise.reject(error)
      }
    )

    // æ·»åŠ å“åº”æ‹¦æˆªå™¨
    axios.interceptors.response.use(
      function (response) {
        // 2xx èŒƒå›´å†…çš„çŠ¶æ€ç éƒ½ä¼šè§¦å‘è¯¥å‡½æ•°
        // å®¢æˆ·ç«¯æ¥æ”¶âœ¨token
        console.log(response.headers)
        const { authorization } = response.headers
        authorization && localStorage.setItem('token', authorization)

        return response
      },
      function (error) {
        if (err.response.status === 401) {
          localStorage.removeItem('token')
          localtion.href = '/login'
        }

        return Promise.reject(error)
      }
    )
  </script>
</head>
<body>
  â€¦â€¦
  <script>
    login.onclick = () => {
      aixos
        .post('/user/login', {
          username: username.value,
          password: password.value
        })
        .then((res) => {
          // console.log(res.data)
          // console.log(res.headers)
          if (res.ok === 1) {
            location.href = '/backend'
          } else {
            alert('ç”¨æˆ·åå¯†ç ä¸åŒ¹é…ï¼ï¼')
          }
        })
    }
  </script>
</body>
```

## äº”ã€Koa ä¸æ–‡ä»¶ä¸Šä¼ 

## å…­ã€Koa ä¸ MongoDB æ•°æ®åº“

### 1ã€å®‰è£…

```sh
npm i mongoose
```

### 2ã€è¿æ¥æ•°æ®åº“

- index.js

```js
require('./config/db.config.js')
```

- æ–°å»ºï¼šconfig/db.config.js

```js
const mongoose = require('mongoose')

mongoose.connect('mongodb://127.0.0.1:27017/ren_db')
```

### 3ã€åˆ›å»ºé›†åˆå¯¹åº”çš„ MongoDB æ¨¡å‹

- æ–°å»ºï¼šmodel/userModel.js

```js
const mongoose = require('mongoose')

const Schema = mongoose.Schema
const UserType = {
  username: String,
  password: String,
  age: Number
  phone: String,
}

// åˆ›å»ºçš„useræ¨¡å‹ï¼Œä¼šè‡ªåŠ¨å¯¹åº”usersé›†åˆ
const userModel = mongoose.model('user', new Schema(UserType))

module.exports = UserModel
```

### 4ã€API æ¥å£

- index.js

```js
const usersRouter = require('./router/usersRouter')

app.use('/api', usersRouter)
```

- router/usersRouter.js

```js
// å¯¼å…¥useræ¨¡å‹ï¼ˆè¿™æ ·å°±å¯ä»¥ğŸš©ä½¿ç”¨user.create | user.find | user.delete | user.updateæ¥æ“ä½œæ•°æ®äº†ï¼‰
const UserModel = require('../model/UserModel')

router.post('/user/add', async (ctx) => {
  console.log(ctx.request.body)
  // âœ¨å‰ç«¯ä¼ æ¥çš„æ•°æ®
  const { username, password, age, phone } = ctx.request.body

  await UserModel.create({
    username,
    password,
    age,
    phone
  }).then((data) => {
    console.log(data)

    ctx.body = {
      ok: 1
    }
  })
})
```
